{% extends "base.html" %}

{% block title %}Ezchain Blockchain Visualization{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center mb-4">Ezchain 区块链可视化界面</h1>
        </div>
    </div>

    <!-- 控制面板 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>系统控制</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button id="initBtn" class="btn btn-primary btn-block">初始化区块链</button>
                        </div>
                        <div class="col-md-3">
                            <button id="startMiningBtn" class="btn btn-success btn-block" disabled>开始挖矿</button>
                        </div>
                        <div class="col-md-3">
                            <button id="stopMiningBtn" class="btn btn-danger btn-block" disabled>停止挖矿</button>
                        </div>
                        <div class="col-md-2">
                            <button id="refreshBtn" class="btn btn-info btn-block">刷新状态</button>
                        </div>
                        <div class="col-md-2">
                            <button id="resetBtn" class="btn btn-warning btn-block">重置系统</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">总区块数</h5>
                    <h2 id="totalBlocks">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">总交易数</h5>
                    <h2 id="totalTransactions">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">挖矿速度</h5>
                    <h2 id="miningSpeed">0.0</h2>
                    <small>区块/秒</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">网络算力</h5>
                    <h2 id="networkHashrate">0</h2>
                    <small>H/s</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-secondary">
                <div class="card-body">
                    <h5 class="card-title">节点数</h5>
                    <h2 id="nodeCount">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-white bg-dark">
                <div class="card-body">
                    <h5 class="card-title">账户数</h5>
                    <h2 id="accountCount">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 区块链可视化 -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>区块链可视化</h4>
                </div>
                <div class="card-body">
                    <div id="blockchainVisualization" class="text-center">
                        <p class="text-muted">请先初始化区块链</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>挖矿状态</h4>
                </div>
                <div class="card-body">
                    <div id="miningStatus">
                        <p class="text-muted">挖矿未开始</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 区块列表 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>区块列表</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>高度</th>
                                    <th>哈希</th>
                                    <th>前一个哈希</th>
                                    <th>矿工</th>
                                    <th>时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="blocksTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">暂无区块数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易功能 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>创建交易</h4>
                </div>
                <div class="card-body">
                    <form id="transactionForm">
                        <div class="form-group">
                            <label for="sender">发送方账户</label>
                            <select class="form-control" id="sender_id" required>
                                <option value="">选择发送方</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="recipient">接收方账户</label>
                            <select class="form-control" id="recipient_id" required>
                                <option value="">选择接收方</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amount">金额</label>
                            <input type="number" class="form-control" id="amount" min="1" required>
                        </div>
                        <button type="submit" class="btn btn-primary">发送交易</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>最近交易</h4>
                </div>
                <div class="card-body">
                    <div id="recentTransactions">
                        <p class="text-muted">暂无交易记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 区块详情模态框 -->
<div class="modal fade" id="blockModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">区块详情</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="blockDetails">
                <!-- 区块详情内容 -->
            </div>
        </div>
    </div>
</div>

<!-- 交易详情模态框 -->
<div class="modal fade" id="transactionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">交易详情</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="transactionDetails">
                <!-- 交易详情内容 -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let blockchainInitialized = false;
let miningInProgress = false;
let refreshInterval;

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateStatus();
    
    // 每5秒自动刷新状态
    refreshInterval = setInterval(updateStatus, 5000);
});

// 初始化事件监听器
function initializeEventListeners() {
    document.getElementById('initBtn').addEventListener('click', initializeBlockchain);
    document.getElementById('startMiningBtn').addEventListener('click', startMining);
    document.getElementById('stopMiningBtn').addEventListener('click', stopMining);
    document.getElementById('refreshBtn').addEventListener('click', updateStatus);
    document.getElementById('resetBtn').addEventListener('click', resetBlockchain);
    document.getElementById('transactionForm').addEventListener('submit', createTransaction);
}

// 初始化区块链
async function initializeBlockchain() {
    try {
        const response = await fetch('/api/blockchain/init', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            blockchainInitialized = true;
            updateButtonStates();
            updateStatus();
            showNotification('区块链初始化成功！', 'success');
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('初始化失败：' + error.message, 'error');
    }
}

// 开始挖矿
async function startMining() {
    try {
        const response = await fetch('/api/mining/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            miningInProgress = true;
            updateButtonStates();
            updateStatus();
            showNotification('挖矿已开始！', 'success');
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('启动挖矿失败：' + error.message, 'error');
    }
}

// 停止挖矿
async function stopMining() {
    try {
        const response = await fetch('/api/mining/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            miningInProgress = false;
            updateButtonStates();
            updateStatus();
            showNotification('挖矿已停止！', 'success');
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('停止挖矿失败：' + error.message, 'error');
    }
}

// 更新状态
async function updateStatus() {
    try {
        const [statsResponse, blocksResponse, accountsResponse, transactionsResponse, nodesResponse] = await Promise.all([
            fetch('/api/blockchain/stats'),
            fetch('/api/blockchain/blocks'),
            fetch('/api/accounts'),
            fetch('/api/transactions'),
            fetch('/api/nodes')
        ]);
        
        const stats = await statsResponse.json();
        const blocks = await blocksResponse.json();
        const accounts = await accountsResponse.json();
        const transactions = await transactionsResponse.json();
        const nodes = await nodesResponse.json();
        
        updateStatistics(stats);
        updateBlockchainVisualization(blocks.blocks);
        updateBlocksTable(blocks.blocks);
        updateAccountsSelect(accounts.accounts);
        updateRecentTransactions(transactions.transactions);
        updateNodesInfo(nodes.nodes);
        
        if (miningInProgress) {
            updateMiningStatus();
        }
        
    } catch (error) {
        console.error('更新状态失败:', error);
    }
}

// 更新统计信息
function updateStatistics(stats) {
    document.getElementById('totalBlocks').textContent = stats.total_blocks || 0;
    document.getElementById('totalTransactions').textContent = stats.total_transactions || 0;
    document.getElementById('miningSpeed').textContent = (stats.mining_speed || 0).toFixed(2);
    document.getElementById('networkHashrate').textContent = (stats.network_hashrate || 0).toLocaleString();
    document.getElementById('nodeCount').textContent = stats.node_count || 0;
    document.getElementById('accountCount').textContent = stats.account_count || 0;
}

// 更新区块链可视化
function updateBlockchainVisualization(blocks) {
    const container = document.getElementById('blockchainVisualization');
    
    if (blocks.length === 0) {
        container.innerHTML = '<p class="text-muted">请先初始化区块链</p>';
        return;
    }
    
    let html = '<div class="blockchain-chain">';
    
    // 只显示最新的10个区块
    const recentBlocks = blocks.slice(-10);
    
    recentBlocks.forEach((block, index) => {
        html += `
            <div class="block-item">
                <div class="block-number">#${block.index}</div>
                <div class="block-hash">${block.hash.substring(0, 8)}...</div>
                <div class="block-miner">矿工: ${block.miner}</div>
            </div>
        `;
        
        if (index < recentBlocks.length - 1) {
            html += '<div class="block-arrow">→</div>';
        }
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// 更新区块列表
function updateBlocksTable(blocks) {
    const tbody = document.getElementById('blocksTable');
    
    if (blocks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无区块数据</td></tr>';
        return;
    }
    
    tbody.innerHTML = blocks.map(block => `
        <tr>
            <td>${block.index}</td>
            <td><code>${block.hash.substring(0, 16)}...</code></td>
            <td><code>${block.pre_hash.substring(0, 16)}...</code></td>
            <td>节点 ${block.miner}</td>
            <td>${new Date(block.time).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="showBlockDetails('${block.hash}')">详情</button>
            </td>
        </tr>
    `).join('');
}

// 更新账户选择器
function updateAccountsSelect(accounts) {
    const senderSelect = document.getElementById('sender_id');
    const recipientSelect = document.getElementById('recipient_id');
    
    const options = accounts.map(account => 
        `<option value="${account.id}">账户 ${account.id} (余额: ${account.balance})</option>`
    ).join('');
    
    senderSelect.innerHTML = '<option value="">选择发送方</option>' + options;
    recipientSelect.innerHTML = '<option value="">选择接收方</option>' + options;
}

// 更新节点信息
function updateNodesInfo(nodes) {
    // 这里可以添加节点信息的显示逻辑
    console.log('节点信息:', nodes);
}

// 更新最近交易
function updateRecentTransactions(transactions) {
    const container = document.getElementById('recentTransactions');
    
    if (transactions.length === 0) {
        container.innerHTML = '<p class="text-muted">暂无交易记录</p>';
        return;
    }
    
    const recentTransactions = transactions.slice(-5);
    
    container.innerHTML = recentTransactions.map(tx => `
        <div class="transaction-item">
            <div class="transaction-id">${tx.id.substring(0, 8)}...</div>
            <div class="transaction-details">
                <div>${tx.sender.substring(0, 8)}... → ${tx.recipient.substring(0, 8)}...</div>
                <div class="transaction-amount">${tx.amount} EZC</div>
            </div>
            <div class="transaction-status">
                <span class="badge badge-${tx.status === 'pending' ? 'warning' : 'success'}">${tx.status}</span>
            </div>
        </div>
    `).join('');
}

// 创建交易
async function createTransaction(event) {
    event.preventDefault();
    
    const sender_id = document.getElementById('sender_id').value;
    const recipient_id = document.getElementById('recipient_id').value;
    const amount = document.getElementById('amount').value;
    
    if (!sender_id || !recipient_id || !amount) {
        showNotification('请填写所有字段', 'error');
        return;
    }
    
    if (sender_id === recipient_id) {
        showNotification('发送方和接收方不能相同', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/transaction/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sender_id: parseInt(sender_id),
                recipient_id: parseInt(recipient_id),
                amount: parseInt(amount)
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('交易创建成功！', 'success');
            document.getElementById('transactionForm').reset();
            updateStatus();
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('创建交易失败：' + error.message, 'error');
    }
}

// 更新挖矿状态
async function updateMiningStatus() {
    try {
        const response = await fetch('/api/mining/status');
        const data = await response.json();
        
        const container = document.getElementById('miningStatus');
        
        if (data.mining_in_progress) {
            container.innerHTML = `
                <div class="mining-active">
                    <div class="spinner-border text-success" role="status">
                        <span class="sr-only">挖矿中...</span>
                    </div>
                    <p class="mt-2">挖矿进行中...</p>
                    <p>当前速度: ${data.stats.mining_speed.toFixed(2)} 区块/秒</p>
                    <p>已产生区块: ${data.stats.total_blocks}</p>
                </div>
            `;
        } else {
            container.innerHTML = '<p class="text-muted">挖矿未开始</p>';
        }
    } catch (error) {
        console.error('更新挖矿状态失败:', error);
    }
}

// 显示区块详情
async function showBlockDetails(blockHash) {
    try {
        const response = await fetch('/api/blockchain/blocks');
        const data = await response.json();
        
        const block = data.blocks.find(b => b.hash === blockHash);
        
        if (block) {
            const details = `
                <div class="block-details">
                    <h6>区块 #${block.index}</h6>
                    <table class="table table-sm">
                        <tr><td><strong>哈希:</strong></td><td><code>${block.hash}</code></td></tr>
                        <tr><td><strong>前一个哈希:</strong></td><td><code>${block.pre_hash}</code></td></tr>
                        <tr><td><strong>矿工:</strong></td><td>节点 ${block.miner}</td></tr>
                        <tr><td><strong>时间:</strong></td><td>${new Date(block.time).toLocaleString()}</td></tr>
                        <tr><td><strong>Nonce:</strong></td><td>${block.nonce}</td></tr>
                        <tr><td><strong>Merkle根:</strong></td><td><code>${block.m_tree_root}</code></td></tr>
                    </table>
                </div>
            `;
            
            document.getElementById('blockDetails').innerHTML = details;
            $('#blockModal').modal('show');
        }
    } catch (error) {
        showNotification('获取区块详情失败', 'error');
    }
}

// 更新按钮状态
function updateButtonStates() {
    document.getElementById('initBtn').disabled = blockchainInitialized;
    document.getElementById('startMiningBtn').disabled = !blockchainInitialized || miningInProgress;
    document.getElementById('stopMiningBtn').disabled = !miningInProgress;
}

// 重置区块链
async function resetBlockchain() {
    if (!confirm('确定要重置整个区块链系统吗？这将清除所有数据。')) {
        return;
    }
    
    try {
        const response = await fetch('/api/blockchain/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            blockchainInitialized = false;
            miningInProgress = false;
            updateButtonStates();
            updateStatus();
            showNotification('区块链已重置！', 'success');
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('重置失败：' + error.message, 'error');
    }
}

// 显示通知
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.insertBefore(notification, document.body.firstChild);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// 页面卸载时清理
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>

<style>
.blockchain-chain {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 20px;
}

.block-item {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    min-width: 120px;
    text-align: center;
    transition: all 0.3s ease;
}

.block-item:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.block-number {
    font-weight: bold;
    color: #495057;
    margin-bottom: 5px;
}

.block-hash {
    font-family: monospace;
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 5px;
}

.block-miner {
    font-size: 11px;
    color: #28a745;
}

.block-arrow {
    font-size: 24px;
    color: #6c757d;
}

.transaction-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
}

.transaction-id {
    font-family: monospace;
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 5px;
}

.transaction-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.transaction-amount {
    font-weight: bold;
    color: #28a745;
}

.mining-active {
    text-align: center;
}

.mining-active .spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}